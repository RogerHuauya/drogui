function [K] = getKOptimal(in)
%x = [0, pi/10, pi/20, 0.01, 0.02, 0, 0, 0, 1, 0, 0, 0.5];
%u = [25, 60, 25, 60];
x = in(1:12);
u = in (13:16);
F = 9.81/1000*( -0.0026*u.*u.*u + 0.4892*u.*u - 4.2855*u + 0.8182);
dF = (9.81/1000) * (-0.0078*u.^2 + 0.9784*u - 4.2855);
Kv = 0.05;
K1 = 0.29*(F(1) + F(2) + F(3) + F(4));
K2 = 0.29*(sin(x(1))*sin(x(3)) + cos(x(1))*cos(x(3))*sin(x(2)));
K3 = -0.29*(cos(x(3))*sin(x(1)) - 1.0*cos(x(1))*sin(x(2))*sin(x(3)));
K4 = 0.29*cos(x(2))*cos(x(1));

A_L =[
0                                                         , 0                                  , 0                                                        , 1           , 0           , 0          , 0 , 0 , 0 , 0 , 0 , 0;
0                                                         , 0                                  , 0                                                        , 0           , 1           , 0          , 0 , 0 , 0 , 0 , 0 , 0;
0                                                         , 0                                  , 0                                                        , 0           , 0           , 1          , 0 , 0 , 0 , 0 , 0 , 0;
0                                                         , 0                                  , 0                                                        , 0           , -0.77*x(6)  , -0.77*x(5) , 0 , 0 , 0 , 0 , 0 , 0;
0                                                         , 0                                  , 0                                                        , 0.78*x(6)   , 0           , 0.78*x(4)  , 0 , 0 , 0 , 0 , 0 , 0;
0                                                         , 0                                  , 0                                                        , -0.011*x(5) , -0.011*x(4) , 0          , 0 , 0 , 0 , 0 , 0 , 0;
0                                                         , 0                                  , 0                                                        , 0           , 0           , 0          , 0 , 0 , 0 , 1 , 0 , 0;
0                                                         , 0                                  , 0                                                        , 0           , 0           , 0          , 0 , 0 , 0 , 0 , 1 , 0;
0                                                         , 0                                  , 0                                                        , 0           , 0           , 0          , 0 , 0 , 0 , 0 , 0 , 1;
K1*(sin(x(3))*cos(x(1)) - sin(x(1))*cos(x(3))*sin(x(2)))  , K1*(cos(x(2))*cos(x(1))*cos(x(3))) , K1*(cos(x(3))*sin(x(1))-cos(x(1))*sin(x(3))*sin(x(2)))   , 0           , 0           , 0          , 0 , 0 , 0 , 0 , 0 , 0;
K1*(-cos(x(1))*cos(x(3)) + sin(x(1))*sin(x(2))*sin(x(3))) , K1*(cos(x(1))*cos(x(2))*sin(x(3))) , K1*(sin(x(3))*sin(x(1)) + cos(x(1))*sin(x(2))*cos(x(3))) , 0           , 0           , 0          , 0 , 0 , 0 , 0 , 0 , 0;
K1*(-sin(x(1))*cos(x(2)))                                 , K1*(-sin(x(2))*cos(x(1)))          , 0                                                        , 0           , 0           , 0          , 0 , 0 , 0 , 0 , 0 , 0;
];

B_L =[
0            , 0           , 0            , 0           ;
0            , 0           , 0            , 0           ;
0            , 0           , 0            , 0           ;
4.2*dF(1)     , -4.2*dF(2)   , -4.2*dF(3)    , 4.2*dF(4)    ;
-4.1*dF(1)    , -4.1*dF(2)   , 4.1*dF(3)     , 4.1*dF(4)    ;
-5.8*Kv*dF(1) , 5.8*Kv*dF(2) , -5.8*Kv*dF(3) , 5.8*Kv*dF(4) ;
0            , 0           , 0            , 0           ;
0            , 0           , 0            , 0           ;
0            , 0           , 0            , 0           ;
K2*dF(1)      , K2*dF(2)     , K2*dF(3)      , K2*dF(4)     ;
K3*dF(1)      , K3*dF(2)     , K3*dF(3)      , K3*dF(4)     ;
K4*dF(1)      , K4*dF(2)     , K4*dF(3)      , K4*dF(4)     ;
];

[K,S,e] = lqr(A_L,B_L,15*eye(12),eye(4))
disp(K)
end
